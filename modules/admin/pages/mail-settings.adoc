= Настройка почты

Раздел содержит настройки сервиса _Workflow_ для обращения к почтовому серверу.

Начиная с версии 5.5.3 модуль _{wf}_ поддерживает работу в мультитенантном режиме. Раньше настройки по умолчанию устанавливались для БД по умолчанию. Теперь, когда БД несколько, при первом открытии настроек модуль попытается автоматически скопировать настройки. Если попытка окажется неудачной, будет выдано предупреждение. В таком случае настройки можно выполнить при помощи <<program,программы "{dv} Настройки почты для Workflow">>.

[#top]
.При первоначальной установке модуля (не обновлении) выполните следующие действия, чтобы задать настройки для обращения к почтовому серверу:
. В разделе настроек модуля _{wf}_ найдите блок _Назначение сервисов для обработки баз данных_.
+
.Блок "Назначение сервисов для обработки баз данных"
image::services-designation.png[Блок "Назначение сервисов для обработки баз данных"]
+
. Найдите _Настройки почты_ (6) и нажмите кнопку *Изменить* (7).
+
[NOTE]
====
Кнопка *Изменить* для почтового шлюза доступна только, когда в списке выбран сервис с сервера, на котором установлен модуль {pl} с Консолью настройки {dv}. Настроить шлюз можно только физически на машине, где установлен данный сервис.
====
+
.Окно "Настройки почты"
image::mail-settings.png[Окно "Настройки почты"]
+
. В окне _Настройки почты_ найдите поле _Тип сервера_ и выберите тип используемого почтового сервера:
+
* *_MS Exchange_*
* *_SMTP/POP3_*
* *_Exchange Web Services_* -- только MS Exchange 2007 SP1 или MS Exchange 2010.
+
. В поле _E-mail сервера_ укажите адрес электронной почты, которым будет пользоваться сервер управления процессами, например, для пересылки электронных писем исполнителям заданий при использовании офлайн-маршрутизации.
+
****
* Если выбран тип (почтового) сервера *_MS Exchange_*, укажите:
+
** _Профиль MS Exchange_ -- название профиля для работы с Microsoft Exchange.
+
Профиль нужно настроить самостоятельно, используя инструмент menu:Панель управления[Почта] (должен быть установлен Microsoft Outlook x86). У учетной записи должны быть права на отправку, получение и удаление электронных писем.
+
* Если выбран тип сервера *_SMTP/POP3_*, укажите:
+
** В поле _Отправка_ -- тип отправки писем (локальный или удаленный), он зависит от настроек SMTP/POP3 сервера. Если выбрана _Локальная_ отправка, письма будут формироваться при помощи приложений Execlogic и перемещаться в папку на сервере Workflow. Сама папка должны быть указана в конфигурационном файле приложения Execlogic.
+
Чтобы указать папку в конфигурационном файле приложения Execlogic, добавьте следующие строки в файлы `ExecLogic.exe.config` и `ExecLogic32.exe.config`:
+
[source]
----
<system.net>
<mailSettings>
<smtp deliveryMethod="SpecifiedPickupDirectory">
<specifiedPickupDirectory pickupDirectoryLocation="Путь-к-каталогу-для-формирования-писем" />
</smtp>
</mailSettings>
</system.net>
----
+
* Если выбран тип сервера *_SMTP сервера_*, укажите:
** В поле *_SMTP сервер_* -- имя сервера.
** Флаг `*SSL*` -- при наличии флага допускается использование протокола защищенного обмена данными _SSL_.
** В поле _Аутентификация_ -- тип аутентификации пользователя:
+
*** *_Нет_*.
*** *_Простая_* -- логин и пароль пользователя указывается явно.
*** *_NTLM_* -- доступ осуществляется от лица текущего пользователя.
+
** _Имя пользователя_ и _Пароль_ для доступа к почтовому ящику.
** Если выбран удаленный тип отправки сообщений, то в случае нестандартной конфигурации SMTP сервера можно нажать кнопку *Дополнительно* и в открывшемся окне _Дополнительные настройки почты_ указать _Порт SMTP_, который будет использован для подключения к серверу и отправки писем. По умолчанию используется стандартный порт `SMTP 25`.
+
.Окно "Дополнительные настройки почты"
image::additional-mail-settings.png[Окно "Дополнительные настройки почты"]
+
[NOTE]
====
SSL при работе по SMTP поддерживается только как расширение службы SMTP для Secure SMTP через TLS. Подключение SMTP/SSL не поддерживается. Поэтому, вместо порта `465`, который используется по умолчанию для SMTP/SSL, следует указывать порт `587`.
====
+
* Если выбран тип сервера *_POP3 сервера_*, укажите:
** В поле _POP3 сервер_ -- имя сервера.
** Флаг *SSL* -- при наличии флага допускается использование протокола защищенного обмена данными *SSL*.
** В поле _Аутентификация_ -- тип аутентификации пользователя:
+
*** *_Простая_* -- логин и пароль пользователя указывается явно.
*** *_NTLM_* -- доступ осуществляется от лица текущего пользователя.
+
** _Имя пользователя_ и _Пароль_ для доступа к почтовому ящику;
** Если выбран удаленный тип отправки сообщений, в случае нестандартной конфигурации POP3 сервера можно нажать кнопку *Дополнительно* и в открывшемся окне _Дополнительные настройки почты_ указать _Порт POP3_, который будет использован для подключения к серверу.
+
* Если выбран тип сервера *_Exchange Web Services_*, укажите:
** _Адрес сервера для подключения_ -- адрес электронной почты, зарегистрированной в веб-службе Exchange и ассоциированной с учетной записью сервиса Workflow или явный адрес сервера.
+
[NOTE]
====
Workflow использует функцию https://docs.microsoft.com/ru-ru/exchange/client-developer/exchange-web-services/autodiscover-for-exchange[автообнаружения] точки подключения к Exchange Web Services по адресу электронной почты, указанной в поле _Адрес сервера для подключения_. Если указан явный адрес сервера, автообнаружение будет отключено. См. дополнительные настройки автообнаружения <<redirect,ниже>>.
====
+
** _Аутентификация_ -- тип аутентификации пользователя:
*** *_Простая_* -- логин и пароль пользователя указывается явно.
*** *_NTLM_* -- доступ осуществляется от лица текущего пользователя.
** _Имя пользователя_ и _Пароль_ для подключения к Exchange WebServices, если используется тип аутентификации *_Простая_*.
****
+
. Чтобы все выполненные изменения вступили в силу, сохраните их и перезапустите службу *{wfs}*.

[#program]
== Настройка почты с помощью программы "{dv} Настройки почты для Workflow"

Для распространения настроек почты на разные сервера предусмотрена специальная утилита _{dv} Настройки почты для Workflow_. Данная утилита позволяет задавать настройки электронной почты для любого сервера Workflow через SMTP/POP3, MS Exchange или через веб-сервисы Exchange.

Интерфейс утилиты почти аналогичен интерфейсу окна <<top,Настройки почты>> в _Консоли настройки {dv}_. Единственное отличие утилиты в том, что в верхней строчке расположен раскрывающийся список БД. Настройка почты выполняется для выбранной в данной строке БД.

.Окно "{dv} Workflow mail gate settings"
image::mail-gate-settings.png[Окно "{dv} Workflow mail gate settings"]

[#redirect]
== Разрешение перенаправления при автообнаружении конечной точки Exchange Web Services

При подключении почтового шлюза Workflow к серверу Exchange Web Services используется функция автообнаружения конечной точки EWS, подробнее см. на https://docs.microsoft.com/ru-ru/exchange/client-developer/exchange-web-services/autodiscover-for-exchange[сайте Microsoft].

По умолчанию, если сервер автообнаружения EWS возвращает статус, перенаправляющий шлюз к почте Workflow на другой адрес подключения, автообнаружение будет завершено с ошибкой.

.Чтобы разрешить такие перенаправления:
. Добавьте в реестр ОС с установленным сервером Workflow специальный параметр:
* Ветка: `{hklm-dv}\Workflow\5.5\WorkflowServer`
* Название параметра: `WebAllowRedirect`.
* Тип: `DWORD`.
* Значение: `1`.
. Перезапустите службу *{wfs}*.
. Если в организации используется кластер Workflow, повторите настройку на всех узлах.
+
[NOTE]
====
Обратите внимание, ветка `{hklm-dv}\Workflow\5.5\WorkflowServer` — это ветка, в которой хранятся настройки по умолчанию. В версиях модуля с поддержкой мультитенантности (5.5.3 и выше) настройки для каждой БД настройки хранятся в собственной ветке реестра.
====

Функция автообнаружения EWS может быть отключена, если указать прямой адрес EWS. Когда при настройке мониторинга почты в поле _Адрес сервера для подключения_ указана почта, функция автообнаружения конечной точки EWS будет работать как раньше. Когда в поле указан явный адрес, автообнаружение будет отключено и будет использован указанный адрес.

[#oauth]
== Авторизация через OAuth при использовании Exchange Web Services

Microsoft прекратила поддержку обычной проверки подлинности в Exchange Online. В связи с этим была добавлена возможность авторизации через OAuth при использовании Exchange Web Services.

[NOTE]
====
Индивидуальная настройка шлюза на уровне UI БП при этом не поддерживается.
====

.Чтобы использовать OAuth с EWS выполните следующие настройки:
. Настройте приложение в требуемом тенанте Azure AD согласно https://docs.microsoft.com/en-us/exchange/client-developer/exchange-web-services/how-to-authenticate-an-ews-application-by-using-oauth[инструкции].
+
Когда есть варианты *delegated authentication* или *app-only authentication*, нужно выбирать вариант *app-only authentication*.
+
.В процессе настройки, необходимо сохранить три значения:
* Идентификатор созданного приложения -- идентификатор клиента, в настройках приложения.
* Идентификатор каталога -- идентификатор тенанта, в настройках приложения.
* Клиентский секрет из раздела _Сертификаты и секреты_.
+
. В реестре, в ветке настроек Worfklow (`{hklm-dv}\Workflow\5.5\WorkflowServer\Tenants`) у подчинённой ветки с именем нужной БД задайте следующие настройки:
+
* `WebUseOAuth (DWORD)`: 1.
* `WebOauthClientId (строка)`: идентификатор созданного приложения.
* `WebOauthTenantId (строка)`: идентификатор каталога (идентификатор тенанта).
* `WebOauthExtData (строка)`: клиентский секрет.
+
. В консоли настроек {dv}, в разделе _{wf}_ включите использование Exchange Web Services с использованием актуального адреса электронной почты, соответствующего нужному почтовому ящику.

При использовании OAuth, в настройке _Адрес сервера для подключения_ (аналогично настройке `WebAutodiscoverURL` в реестре) должен быть указан адрес email. Использование прямого адреса для подключения в этом случае не допускается.
