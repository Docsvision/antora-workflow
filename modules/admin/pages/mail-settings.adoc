= Настройки почты в конфигурационном файле модуля

Раздел содержит настройки сервиса _Workflow_ для обращения к почтовому серверу:

* MS Exchange
+
WARNING: Не поддерживается в Linux.
+
* SMTP/POP3
* MS Exchange Web Services -- только MS Exchange 2007 SP1 или MS Exchange 2010.

Модуль _{wf}_ поддерживает работу в мультитенантном режиме.

[#top]
.При первоначальной установке модуля (не обновлении) выполните следующие действия, чтобы задать настройки для обращения к почтовому серверу:
. В конфигурационном файле модуля _{wf}_ найдите параметр `"ServiceUrl"` -- адрес сервера {dv}.
. Найдите параметр `"WorkflowServer"` и задайте в нём настройки почты.
+
Настройка параметров работы модуля _{wf}_ осуществляется в разделе настроек _WorkflowServer_ в конфигурационном файле модуля `/usr/lib/docsvision/workflow/appsettings.json`.
+
Раздел настроек почты в конфигурационном файле модуля выглядит следующим образом:
+
[source,json]
----
  "DocsVision": {
    "Workflow": {
      "ServiceUrl": "http://dvserver.domain.com:5000/api/v1", <.>
      "BaseName": "alias", <.>
      "WorkflowServer": {
        "ServiceID":"http://workflow.domain.com:5099", <.>
        "MemorySize": "1000",

        "UseCDOSys": "1", <.>
        "ServerAddress": "account@domain.com", <.>

        "Pop3Server": "pop3.domain.com", <.>
        "Pop3Authenticate": 0, <.>
        "Pop3UserName": "account@domain.com", <.>
        "Pop3Password": "password", <.>
        "Pop3Port": 110, <.>
        "Pop3Timeout": 30, <.>
        "Pop3UseSsl": 0, <.>
        "POP3NoCertificateRevocationCheck": 0, <.>

        "SmtpServer": "smtp.domain.com", <.>
        "SmtpAuthenticate": "1", <.>
        "SmtpUsername": "account@domain.com", <.>
        "SmtpPassword": "password", <.>
        "SmtpPort": "465", <.>
        "SmtpTimeout": 30, <.>
        "SmtpUseSsl": "0", <.>

        "WebAutodiscoverURL": "http://domain.com", <.>
        "WebUserName": "account@domain.com", <.>
        "WebPassword": "password", <.>
        "WebServiceVersion": 0, <.>
        "WebUseDefaultCredentials": 0 <.>
      }
    }
  },
----
<.> `ServiceUrl` -- адрес сервера {dv}. Обратите внимание на api/v1 в адресе.
<.> `BaseName` -- псевдоним базы данных, для обработки которой предназначается сервис. Должен совпадать с псевдонимом подключенной базы в конфигурации сервера {dv}.
<.> `ServiceID` -- адрес Сервиса управления бизнес-процессами. Адрес обязательно должен совпадать с тем, что будет указан в _Консоли настройки {dv}_. Сервис управления бизнес-процессами должен быть доступен по данному адресу "снаружи".
<.> `UseCDOSys` -- тип почтового сервера: `1` -- SMTP/POP3, `2` -- Exchange Web Services.
<.> `ServerAddress` -- укажите адрес электронной почты, который будет использован сервером управления процессами, например, для пересылки электронных писем исполнителям заданий при использовании офлайн-маршрутизации.
<.> `Pop3Server` -- имя POP3 сервера.
<.> `Pop3Authenticate` -- тип аутентификации пользователя POP3:
+
* `0` -- _Простая_ -- логин и пароль пользователя указывается явно.
* `1` -- _NTLM_ -- доступ осуществляется от лица текущего пользователя (не поддерживается в Linux).
+
<.> `Pop3UserName` -- имя пользователя для доступа к почтовому ящику POP3, если используется тип аутентификации _Простая_.
<.> `Pop3Password` -- пароль пользователя для доступа к почтовому ящику POP3, если используется тип аутентификации _Простая_.
<.> `Pop3Port` -- в случае нестандартной конфигурации POP3 сервера можно указать _Порт POP3_, который будет использован для подключения к серверу.
<.> `Pop3Timeout` -- время ожидания ответа POP3 сервера в секундах.
<.> `Pop3UseSsl` -- флаг SSL -- при наличии флага допускается использование протокола защищенного обмена данными SSL: `0` -- не использовать, `1` - использовать.
<.> `POP3NoCertificateRevocationCheck` -- настройка позволяет отключить проверку отозванности сертификата на уровне клиента POP3. Возможные значения: `1` -- проверка отключена, сертификат не проверяется, `0` -- проверка выполняется всегда, значение по умолчанию.
<.> `SmtpServer` -- имя SMTP-сервера.
<.> `SmtpAuthenticate` -- тип аутентификации пользователя:
+
* `0` -- _Анонимная_.
* `1` -- _Простая_ -- логин и пароль пользователя указывается явно.
* `2` -- _NTLM_ -- доступ осуществляется от лица текущего пользователя (не поддерживается в Linux).
+
<.> `SmtpUsername` -- имя пользователя для доступа к почтовому ящику SMTP, если используется тип аутентификации _Простая_.
<.> `SmtpPassword` -- пароль для доступа к почтовому ящику SMTP, если используется тип аутентификации _Простая_.
<.> `SmtpPort` -- в случае нестандартной конфигурации SMTP сервера можно указать _Порт SMTP_, который будет использован для подключения к серверу и отправки писем.
<.> `SmtpTimeout` время ожидания ответа SMTP сервера в секундах.
<.> `SmtpUseSsl` -- флаг SSL -- при наличии флага допускается использование протокола защищенного обмена данными SSL. +
SSL при работе по SMTP поддерживается только как расширение службы SMTP для Secure SMTP через TLS. Подключение SMTP/SSL не поддерживается. Поэтому, вместо порта `465`, который используется по умолчанию для SMTP/SSL, следует указывать порт `587`.
+
<.> `WebAutodiscoverURL` -- адрес электронной почты, зарегистрированной в веб-службе Exchange и ассоциированной с учетной записью сервиса Workflow или явный адрес сервера.
+
Workflow использует функцию https://docs.microsoft.com/ru-ru/exchange/client-developer/exchange-web-services/autodiscover-for-exchange[автообнаружения] точки подключения к Exchange Web Services по адресу электронной почты, указанной в поле _Адрес сервера для подключения_. Если указан явный адрес сервера, автообнаружение будет отключено. См. дополнительные настройки автообнаружения <<redirect,ниже>>.
+
<.> `WebUserName` -- имя пользователя для аутентификации MS Exchange Web Services, если используется тип аутентификации _Простая_.
<.> `WebPassword` -- пароль пользователя для аутентификации MS Exchange Web Services, если используется тип аутентификации _Простая_.
<.> `WebServiceVersion` -- версия сервиса: 0 - 2007 SP1, 1 - 2010.
<.> `WebUseDefaultCredentials` -- тип аутентификации пользователя:
+
* `0` -- _Простая_ -- логин и пароль пользователя указывается явно.
* `1` -- _NTLM_ -- доступ осуществляется от лица текущего пользователя (не поддерживается в Linux).
+
. Чтобы все выполненные изменения вступили в силу, сохраните их и перезапустите службу *{wfs-new}*.

WARNING: По умолчанию в конфигурационном файле указаны пустые параметры, например `null` или `0`. Администратор должен самостоятельно настроить необходимые параметры.

****
Выбор типа отправки писем (локальный или удаленный) больше не поддерживается.
****

// [#program]
// == Настройка почты с помощью программы "{dv} Настройки почты для Workflow"
//
// Для распространения настроек почты на разные сервера предусмотрена специальная утилита _{dv} Настройки почты для Workflow_. Данная утилита позволяет задавать настройки электронной почты для любого сервера Workflow через SMTP/POP3, MS Exchange или через веб-сервисы Exchange.
//
// Интерфейс утилиты почти аналогичен интерфейсу окна <<top,Настройки почты>> в _Консоли настройки {dv}_. Единственное отличие утилиты в том, что в верхней строчке расположен раскрывающийся список БД. Настройка почты выполняется для выбранной в данной строке БД.
//
// .Окно "{dv} Workflow mail gate settings"
// image::mail-gate-settings.png[Окно "{dv} Workflow mail gate settings"]

[#redirect]
== Разрешение перенаправления при автообнаружении конечной точки Exchange Web Services

При подключении почтового шлюза Workflow к серверу Exchange Web Services используется функция автообнаружения конечной точки EWS, подробнее см. на https://docs.microsoft.com/ru-ru/exchange/client-developer/exchange-web-services/autodiscover-for-exchange[сайте Microsoft].

По умолчанию, если сервер автообнаружения EWS возвращает статус, перенаправляющий шлюз к почте Workflow на другой адрес подключения, автообнаружение будет завершено с ошибкой.

.Чтобы разрешить такие перенаправления:
. Добавьте в конфигурационном файле модуля в параметр `WorkflowServer` дополнительный параметр: `WebAllowRedirect` со значением `1`:
+
[source,json]
----
  "Docsvision": {
    "Workflow": {
      "WorkflowServer": {
        "WebAllowRedirect": 1
      }
    }
  },
----
+
. Перезапустите службу *{wfs-new}*.
. Если в организации используется кластер Workflow, повторите настройку на всех узлах.
+
[NOTE]
====
Обратите внимание, настройки для каждой БД хранятся в отдельных параметрах.
====

Функция автообнаружения EWS может быть отключена, если указать прямой адрес EWS. Когда при настройке мониторинга почты в поле _Адрес сервера для подключения_ указана почта, функция автообнаружения конечной точки EWS будет работать как раньше. Когда в поле указан явный адрес, автообнаружение будет отключено и будет использован указанный адрес.

[#oauth]
== Авторизация через OAuth при использовании Exchange Web Services

Microsoft больше не поддерживает обычную проверку подлинности в Exchange Online. В связи с этим рекомендуется использовать авторизацию через OAuth при использовании Exchange Web Services.

[NOTE]
====
Индивидуальная настройка шлюза на уровне UI БП при этом не поддерживается.
====

.Чтобы использовать OAuth с EWS выполните следующие настройки:
. Настройте приложение в требуемом тенанте Azure AD согласно https://docs.microsoft.com/en-us/exchange/client-developer/exchange-web-services/how-to-authenticate-an-ews-application-by-using-oauth[инструкции].
+
Когда есть варианты *delegated authentication* или *app-only authentication*, нужно выбирать вариант *app-only authentication*.
+
.В процессе настройки, необходимо сохранить три значения:
* Идентификатор созданного приложения -- идентификатор клиента, в настройках приложения.
* Идентификатор каталога -- идентификатор тенанта, в настройках приложения.
* Клиентский секрет из раздела _Сертификаты и секреты_.
+
. В конфигурационном файле, в параметре `Worfklow` создайте дополнительный параметр `Tenants`, у подчинённого параметра с именем нужной БД задайте следующие настройки:
+
[source,json]
----
  "Docsvision": {
    "Workflow": {
      "Tenants": {
        "docsvisiondb": {
          "WebUseOAuth": 1, <.>
          "WebOauthClientId": null, <.>
          "WebOauthTenantId": null, <.>
          "WebOauthExtData": null <.>
        }
      }
    }
  },
----
<.> `WebUseOAuth` -- использовать авторизацию через OAuth.
<.> `WebOauthClientId` -- идентификатор созданного приложения.
<.> `WebOauthTenantId` -- идентификатор каталога (идентификатор тенанта).
<.> `WebOauthExtData` -- клиентский секрет.
+
. В консоли настроек {dv}, в разделе _{wf}_ включите использование Exchange Web Services с использованием актуального адреса электронной почты, соответствующего нужному почтовому ящику.

При использовании OAuth, в настройке _Адрес сервера для подключения_ (аналогично настройке `WebAutodiscoverURL`) должен быть указан адрес email. Использование прямого адреса для подключения в этом случае не допускается.
